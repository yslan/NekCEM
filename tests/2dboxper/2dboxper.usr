c-----------------------------------------------------------------------
c
c  USER SPECIFIED ROUTINES:
c
c     - boundary conditions
c     - initial conditions
c     - variable properties
c     - forcing function for fluid (f)
c     - forcing function for passive scalar (q)
c     - general purpose routine for checking errors etc.
c
c-----------------------------------------------------------------------
      subroutine userinc
c-----------------------------------------------------------------------
      include 'SIZE'
      include 'TOTAL'
      include 'EMWAVE'
      include 'NEKUSE'


      return
      end
c-----------------------------------------------------------------------
      subroutine userini(tt, myhx, myhy, myhz, myex, myey, myez)
c-----------------------------------------------------------------------
      include 'SIZE'
      include 'TOTAL'
      include 'EMWAVE'
      include 'NEKUSE'

      real tt
      real myhx(lx1,ly1,lz1,lelt)
      real myhy(lx1,ly1,lz1,lelt)
      real myhz(lx1,ly1,lz1,lelt)
      real myex(lx1,ly1,lz1,lelt)
      real myey(lx1,ly1,lz1,lelt)
      real myez(lx1,ly1,lz1,lelt)

      call usersol(tt,myhx, myhy, myhz, myex, myey, myez)

      return
      end

c-----------------------------------------------------------------------
      subroutine usersol(tt,myshx,myshy,myshz,mysex,mysey,mysez)
c-----------------------------------------------------------------------
      implicit none
      include 'SIZE'
      include 'TOTAL'
      include 'EMWAVE'
      include 'NEKUSE'
      include 'GEOMBOUND'

      real tt
      real myshx(lx1,ly1,lz1,lelt)
      real myshy(lx1,ly1,lz1,lelt)
      real myshz(lx1,ly1,lz1,lelt)
      real mysex(lx1,ly1,lz1,lelt)
      real mysey(lx1,ly1,lz1,lelt)
      real mysez(lx1,ly1,lz1,lelt)

      real omega,tmph,tmpe
      real xx,yy,zz,u
      integer i,j,k,e,ii,ind

      if (ndim.eq.3) then
         omega = sqrt(3.0)

         tmpH = sin(omega*tt)/omega
         tmpE = cos(omega*tt)

         do i = 1,nx1*ny1*nz1*nelt
            xx = xm1(i,1,1,1)
            yy = ym1(i,1,1,1)
            zz = zm1(i,1,1,1)

            myshx(i,1,1,1) = 2*cos(xx)*sin(yy)*cos(zz)*tmph
            myshy(i,1,1,1) = -sin(xx)*cos(yy)*cos(zz)*tmph
            myshz(i,1,1,1) = sin(xx)*sin(yy)*sin(zz)*tmph
            mysex(i,1,1,1) = 0.0
            mysey(i,1,1,1) = cos(xx)*sin(yy)*sin(zz)*tmpe
            mysez(i,1,1,1) = cos(xx)*cos(yy)*cos(zz)*tmpe
         enddo
      else
        omega = sqrt(2.0)

        if (iftm) then
           tmph = sin(omega*tt)/omega
           tmpe = cos(omega*tt)

           do i = 1,nx1*ny1*nz1*nelt
              xx = xm1(i,1,1,1)
              yy = ym1(i,1,1,1)
              zz = zm1(i,1,1,1)

              myshx(i,1,1,1) = cos(xx)*sin(yy)*tmph
              myshy(i,1,1,1) = -sin(xx)*cos(yy)*tmpe
              myshz(i,1,1,1) = 0.0
              mysex(i,1,1,1) = 0.0
              mysey(i,1,1,1) = 0.0
              mysez(i,1,1,1) = cos(xx)*cos(yy)*tmpe
           enddo
        elseif (ifte) then
           tmph = cos(omega*tt)
           tmpe = sin(omega*tt)/omega

           do i = 1,nx1*ny1*nz1*nelt
              xx = xm1(i,1,1,1)
              yy = ym1(i,1,1,1)
              zz = zm1(i,1,1,1)

              myshx(i,1,1,1) = 0.0
              myshy(i,1,1,1) = 0.0
              myshz(i,1,1,1) = sin(xx)*sin(yy)*tmph
              mysex(i,1,1,1) = sin(xx)*cos(yy)*tmpe
              mysey(i,1,1,1) = -cos(xx)*sin(yy)*tmpe
              mysez(i,1,1,1) = 0.0
           enddo
        else
           call exitt
        endif
      endif

      return
      end
c-----------------------------------------------------------------------
      subroutine usersrc(baseidx,srchx,srchy,srchz,srcex,srcey,srcez)

      include 'SIZE'
      include 'TOTAL'
      include 'EMWAVE'
      include 'NEKUSE'
      include 'PML'

      return
      end
c-----------------------------------------------------------------------
      subroutine uservp(ix,iy,iz,iel)
c-----------------------------------------------------------------------
      implicit none
      include 'SIZE'
      include 'TOTAL'
      include 'EMWAVE'
      include 'NEKUSE'

c     These don't do anything! This is a temporary measure until
c
c     https://github.com/NekCEM/NekCEM/issues/12
c
c     is resolved.
      integer ix,iy,iz,iel

      integer i

      do i = 1,npts
         permittivity(i) = 1.0
         permeability(i) = 1.0
      enddo

      return
      end
c-----------------------------------------------------------------------
      subroutine userq  (ix,iy,iz,ieg)
      include 'SIZE'
      include 'TOTAL'
      include 'NEKUSE'
C
      qvol   = 0.0
      source = 0.0

      return
      end
c-----------------------------------------------------------------------
      subroutine useric (ix,iy,iz,ieg)
      include 'SIZE'
      include 'TOTAL'
      include 'NEKUSE'
C

      return
      end
c-----------------------------------------------------------------------
      subroutine userbc (ix,iy,iz,iside,ieg)
      include 'SIZE'
      include 'TOTAL'
      include 'NEKUSE'

      ux=0.0
      uy=0.0
      uz=0.0
      temp=0.0

      return
      end
c-----------------------------------------------------------------------
      subroutine usrdat

      include 'SIZE'
      include 'TOTAL'
      include 'EMWAVE'
      include 'NEKUSE'

      return
      end

c-----------------------------------------------------------------------
      subroutine usrdat2
c-----------------------------------------------------------------------
      implicit none
      include 'SIZE'
      include 'TOTAL'
      include 'EMWAVE'
      include 'NEKUSE'

      integer i,n
      real sx,sy,sz
      real glmin,glmax
      real xmin,ymin,zmin
      real xmax,ymax,zmax

      n = nx1*ny1*nz1*nelv

      xmin = glmin(xm1,n)
      xmax = glmax(xm1,n)
      ymin = glmin(ym1,n)
      ymax = glmax(ym1,n)
      zmin = glmin(zm1,n)
      zmax = glmax(zm1,n)

      sx = 2.0*pi/(xmax-xmin)
      sy = 2.0*pi/(ymax-ymin)
      if (if3d) sz = 2.0*pi/(zmax-zmin)
      nmscale = 2.0*pi/(xmax-xmin)

      if (if3d) then
         do i = 1,n
            xm1(i,1,1,1) = sx*(xm1(i,1,1,1)-xmin)
            ym1(i,1,1,1) = sy*(ym1(i,1,1,1)-ymin)
            zm1(i,1,1,1) = sz*(zm1(i,1,1,1)-zmin)
         enddo
      else
         do i = 1,n
            xm1(i,1,1,1) = sx*(xm1(i,1,1,1)-xmin)
            ym1(i,1,1,1) = sy*(ym1(i,1,1,1)-ymin)                        
         enddo
      endif

      return
      end
c-----------------------------------------------------------------------
      subroutine userft
      include 'SIZE'
      include 'TOTAL'
      include 'EMWAVE'


      return
      end

c-----------------------------------------------------------------------
      subroutine userchk
c-----------------------------------------------------------------------
      implicit none
      include 'SIZE'
      include 'TOTAL'
      include 'EMWAVE'

      real l2htol(3),l2etol(3)
      real linfhtol(3),linfetol(3)

      l2htol(1) = 0.0
      l2htol(2) = 0.0
      l2htol(3) = 5e-8
      l2etol(1) = 5e-8
      l2etol(2) = 5e-8
      l2etol(3) = 0.0

      linfhtol(1) = 0.0
      linfhtol(2) = 0.0
      linfhtol(3) = 5e-7
      linfetol(1) = 5e-7
      linfetol(2) = 5e-7
      linfetol(3) = 0.0

      if (istep.le.10.or.mod(istep,iocomm).eq.0) then
         call usersol(time,shn(1,1),shn(1,2),shn(1,3),sen(1,1),sen(1,2)
     $        ,sen(1,3))

         call cem_errorchk(hn,shn,errhn,l2htol,linfhtol)
         call cem_errorchk(en,sen,erren,l2etol,linfetol)
      endif

      return
      end
c-----------------------------------------------------------------------
