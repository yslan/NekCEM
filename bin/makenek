#!/bin/bash
#-------------------------------------------------------------------------------
# NekCEM build file
#-------------------------------------------------------------------------------

# Installation path. Default is one directory up from the location of
# this script.
NEK="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"/..

# Specify the compilers, linker, and flags. There are three ways to do this.
#
# 1) Leave everything blank. The script will attempt to find your
#    system compilers and set appropriate flags.
# 2) Set only ARCH. There are preset combinations for some common
#    systems; you can see the complete list in
#    NekCEM/bin/arch.json. So for example, if you're compiling on
#    cetus you can just set ARCH="cetus" and everything will work.
# 3) Set FC/FFLAGS/CC/CFLAGS/LD/LDFLAGS manually. If you just set a
#    compiler/linker but not the flags the script will attempt to set
#    them to reasonable defaults.
#
# With any of these methods you can set EXTRA(C|F|LD)FLAGS if you wish
# to pass additional flags.
ARCH=""

# Fortran/C compiler/linker
FC=""
CC=""
LD=""

# Fortran/C/linker flags
FFLAGS=""
CFLAGS=""
LDFLAGS=""

# Extra Fortran/C/linker flags
EXTRAFFLAGS=""
EXTRACFLAGS=""
EXTRALDFLAGS=""

#-------------------------------------------------------------------------------
# Optional Settings
#-------------------------------------------------------------------------------

# MPI (default true)
#IFMPI="false"

# Paths
NEKSRC="$NEK/src"
JLSRC="$NEK/src/jl"

#-------------------------------------------------------------------------------
# Don't touch what follows
#-------------------------------------------------------------------------------

set -e

# Create makefile
$NEK/bin/configurenek --FC "$FC" --FFLAGS "$FFLAGS" \
		      --extra-FFLAGS "$EXTRAFFLAGS" \
		      --CC "$CC" --CFLAGS "$CFLAGS" \
		      --extra-CFLAGS "$EXTRACFLAGS" \
		      --LD "$LD" --LDFLAGS "$LDFLAGS" \
		      --extra-LDFLAGS "$EXTRALDFLAGS" \
		      --jl "$JLSRC" --arch "$ARCH"
# Compile
make -j4 2>&1 | tee compiler.out
exit 0
